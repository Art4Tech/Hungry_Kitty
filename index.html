<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hungry Kitty v37</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #2d3436; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none;
            user-select: none;
        }
        
        canvas { 
            display: block; 
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }
        
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 100;
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 15, 20, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: all;
            z-index: 200;
            transition: opacity 0.5s;
            backdrop-filter: blur(5px);
            padding: 20px;
            box-sizing: border-box;
        }
        
        .hidden { display: none !important; }
        
        h1 { 
            color: #a29bfe; 
            text-shadow: 0 0 20px #6c5ce7; 
            font-size: 2.5rem; 
            margin: 0 0 10px 0; 
            text-align: center; 
        }
        p { color: #dfe6e9; text-align: center; font-size: 1.1rem; opacity: 0.9; margin: 5px; max-width: 600px; }
        
        .emoji-art { font-size: 4rem; margin: 15px 0; animation: float 3s infinite ease-in-out; }
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }

        .slider-container {
            margin-top: 20px;
            text-align: center;
            color: #dfe6e9;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(162, 155, 254, 0.3);
        }
        
        input[type=range] {
            -webkit-appearance: none; width: 200px; height: 8px;
            border-radius: 5px; background: #dfe6e9; outline: none; margin: 10px 0;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px;
            border-radius: 50%; background: #6c5ce7; cursor: pointer;
        }

        button {
            margin-top: 30px;
            padding: 15px 40px;
            font-size: 1.3rem;
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            border: none;
            color: white;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.5);
            font-weight: bold;
        }
        button:active { transform: scale(0.95); }

        #hud {
            padding: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.8);
            display: flex;
            justify-content: space-between;
            width: 100%;
            box-sizing: border-box;
        }
        
        #safety-msg {
            color: #fab1a0;
            font-size: 1.2rem;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.5s;
        }

        #stamina-container {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            width: 300px; height: 15px; background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.5);
            border-radius: 10px; overflow: hidden; z-index: 150;
        }
        #stamina-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #f1c40f, #f39c12); transition: width 0.1s linear; }
        #stamina-label { position: absolute; top: -25px; left: 0; width: 100%; text-align: center; color: white; font-size: 0.9rem; font-weight: bold; text-shadow: 1px 1px 0 #000; }

        #footer {
            position: absolute; bottom: 10px; width: 100%;
            text-align: center; color: rgba(255, 255, 255, 0.4);
            font-size: 0.8rem; pointer-events: none; z-index: 500;
            text-shadow: 1px 1px 2px black;
        }

        #controls-layer {
            position: absolute; bottom: 20px; width: 100%; height: 150px; pointer-events: none;
            display: flex; justify-content: space-between; padding: 0 30px; box-sizing: border-box;
        }

        #joystick-zone {
            width: 140px; height: 140px; background: rgba(255, 255, 255, 0.1); border-radius: 50%;
            pointer-events: auto; border: 2px solid rgba(255,255,255,0.2); backdrop-filter: blur(2px);
            position: relative; display: none; 
        }
        #joystick-knob {
            width: 60px; height: 60px; background: rgba(255, 255, 255, 0.3); border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(255,255,255,0.1);
        }

        #dash-btn {
            width: 100px; height: 100px; background: rgba(255, 107, 107, 0.4); border: 4px solid rgba(255, 107, 107, 0.8);
            border-radius: 50%; pointer-events: auto; display: flex; align-items: center; justify-content: center;
            font-size: 40px; color: white; user-select: none; margin-top: 20px; transition: background 0.1s; cursor: pointer;
            margin-left: auto;
        }
        #dash-btn:active { background: rgba(255, 107, 107, 0.7); transform: scale(0.95); }
    </style>
</head>
<body>

    <div id="start-screen" class="screen">
        <h1>Hungry Kitty v37</h1>
        <p>Traverse the <b>City</b>, <b>Garden</b>, <b>Forest</b>, and <b>Tundra</b>.</p>
        <p>Goal: Reach the <b>Cozy Cabin</b> at the summit!</p>
        <div class="emoji-art">üê±üèôÔ∏èüå≤üèîÔ∏è</div>
        
        <div class="slider-container">
            <label for="diff-slider">Difficulty: <span id="diff-label" style="color:#a29bfe; font-weight:bold;">Normal</span></label><br>
            <input type="range" id="diff-slider" min="1" max="3" value="2" step="1" oninput="updateDiffLabel()">
        </div>

        <button id="start-btn" onclick="startGame()">Start Adventure</button>
    </div>

    <div id="fail-screen" class="screen hidden">
        <h1 style="color: #ff7675">CAUGHT!</h1>
        <div class="emoji-art">üôÄ</div>
        <p id="fail-msg">The dogs got you...</p>
        <p>But you didn't have enough snacks!</p>
        <button onclick="location.reload()">Try Again</button>
    </div>

    <div id="survival-screen" class="screen hidden">
        <h1 style="color: #fab1a0">WELL FED!</h1>
        <div class="emoji-art">üò∫üò∏üê∂</div>
        <p>Congratulations! You got enough snacks to share with the puppy!</p>
        <p>Keep going next time to reach the cabin.</p>
        <button onclick="location.reload()">Play Again</button>
    </div>

    <div id="win-screen" class="screen hidden">
        <h1 style="color: #ffeaa7">KITTY VALHALLA</h1>
        <div class="emoji-art">üî•üò∫üê∂üí§</div>
        <p>Congratulations! You reached the cabin!</p>
        <p>You and the puppy had plenty of snacks.</p>
        <p>Now you both sleep cozy by the fire.</p>
        <button onclick="location.reload()">Rest Now</button>
    </div>

    <div id="ui-layer">
        <div id="hud">
            <span id="score-text">üêü 0/25</span>
            <span id="safety-msg">READY?</span>
        </div>
        <div id="stamina-container">
            <div id="stamina-label">ENERGY</div>
            <div id="stamina-fill"></div>
        </div>
        <div id="controls-layer">
            <div id="joystick-zone"><div id="joystick-knob"></div></div>
            <div id="dash-btn" onmousedown="startDash()" onmouseup="endDash()" ontouchstart="startDash()" ontouchend="endDash()">‚ö°</div>
        </div>
    </div>

    <div id="footer">Created by Arthur Fedderson &copy; Art4Tech 2025</div>
    <canvas id="gameCanvas"></canvas>

<script>
    // --- CONFIGURATION ---
    const GAME_WIDTH = 2000;
    const GAME_HEIGHT = 6000;
    
    const CONFIG = {
        city:   { dogs: 15, treats: 12, color: '#57606f' }, 
        grass:  { dogs: 12, treats: 10, color: '#27ae60' },
        forest: { dogs: 20, treats: 8,  color: '#2c3e50' },
        snow:   { dogs: 25, treats: 6,  color: '#dfe6e9' }
    };

    let MAX_TREATS = 25;
    let DIFFICULTY = 2;

    // --- GLOBALS ---
    let canvas, ctx, width, height;
    let gameActive = false, lastTime = 0, globalTime = 0, graceTimer = 3.0, score = 0;
    let camera = { x: 0, y: 0, zoom: 1.0 };
    let player = null; 
    let entities = []; 
    const input = { x: 0, y: 0, active: false };
    const keys = { w:false, a:false, s:false, d:false };
    let isDashing = false;
    let audioCtx, masterGain;
    let patterns = {};

    // --- INIT ---
    window.onload = function() {
        canvas = document.getElementById('gameCanvas');
        resize();
        ctx = canvas.getContext('2d', { alpha: false });
        
        window.addEventListener('resize', resize);
        setupInput();
        updateDiffLabel(); // Safely call function
        
        if('ontouchstart' in window || navigator.maxTouchPoints > 0) {
            document.getElementById('joystick-zone').style.display = 'block';
            document.getElementById('dash-btn').style.marginLeft = '0'; 
        }
        generateTextures();
    };

    // Define globally accessible functions
    function updateDiffLabel() {
        const slider = document.getElementById('diff-slider');
        const label = document.getElementById('diff-label');
        if (!slider || !label) return;
        const val = slider.value;
        const labels = ["Easy (Slow)", "Normal", "Hard (Fast)"];
        label.innerText = labels[val-1];
    }

    function startGame() {
        document.getElementById('start-screen').classList.add('hidden');
        resize();

        const slider = document.getElementById('diff-slider');
        if(slider) {
            DIFFICULTY = parseInt(slider.value);
            if(DIFFICULTY === 1) MAX_TREATS = 15;
            if(DIFFICULTY === 2) MAX_TREATS = 25;
            if(DIFFICULTY === 3) MAX_TREATS = 35;
        }

        initWorld();
        try { initAudio(); } catch(e) {}
        
        gameActive = true;
        lastTime = Date.now();
        document.getElementById('safety-msg').style.opacity = 1;
        requestAnimationFrame(loop);
    }

    function generateTextures() {
        patterns.city = createPattern('#636e72', 'grid');
        patterns.grass = createPattern('#27ae60', 'noise');
        patterns.forest = createPattern('#0a3d62', 'leaf');
        patterns.snow = createPattern('#dfe6e9', 'crystal');
    }

    function createPattern(color, type) {
        const c = document.createElement('canvas');
        c.width = 100; c.height = 100;
        const x = c.getContext('2d');
        x.fillStyle = color;
        x.fillRect(0,0,100,100);
        x.fillStyle = 'rgba(255,255,255,0.1)';
        
        if(type === 'grid') { // City
            x.fillRect(0, 95, 100, 5); x.fillRect(95, 0, 5, 100);
        } else if (type === 'noise') { // Grass
            for(let i=0; i<50; i++) x.fillRect(Math.random()*100, Math.random()*100, 2, 2);
        } else if (type === 'leaf') { // Forest
            for(let i=0; i<20; i++) {
                x.beginPath(); x.arc(Math.random()*100, Math.random()*100, 4, 0, 6.28); x.fill();
            }
        } else { // Snow
            x.fillStyle = 'rgba(255,255,255,0.4)';
            for(let i=0; i<20; i++) {
                x.beginPath(); x.arc(Math.random()*100, Math.random()*100, 2, 0, 6.28); x.fill();
            }
        }
        return ctx.createPattern(c, 'repeat');
    }

    function resize() {
        width = window.innerWidth; height = window.innerHeight;
        if(canvas) { canvas.width = width; canvas.height = height; }
    }

    function initWorld() {
        entities = []; score = 0;
        let pSpeed = 4.0 + (DIFFICULTY * 0.5);
        player = {
            type: 'player',
            x: GAME_WIDTH / 2, y: GAME_HEIGHT - 200, z: 0,
            width: 30, height: 30, speed: pSpeed,
            vx: 0, vy: 0, angle: -Math.PI/2, state: 'idle',
            stamina: 100, maxStamina: 100, hidden: false
        };
        entities.push(player);

        spawnBiome(0, 1500, 'snow', CONFIG.snow);
        spawnBiome(1500, 3000, 'forest', CONFIG.forest);
        spawnBiome(3000, 4500, 'grass', CONFIG.grass);
        spawnBiome(4500, 6000, 'city', CONFIG.city);

        entities.push({ type: 'cabin', x: GAME_WIDTH/2, y: 100, width: 120, height: 100 });
        
        document.getElementById('score-text').innerText = `üêü 0/${MAX_TREATS}`;
        camera.x = player.x; camera.y = player.y;
    }

    function spawnBiome(minY, maxY, type, settings) {
        let dogMult = (DIFFICULTY === 1) ? 0.6 : (DIFFICULTY === 3 ? 1.4 : 1.0);
        let count = Math.max(1, Math.floor(settings.dogs * dogMult)); 
        
        for(let i=0; i<25; i++) {
            let x = Math.random() * (GAME_WIDTH-100) + 50;
            let y = Math.random() * (maxY - minY) + minY;
            if(y > GAME_HEIGHT - 300) continue; 
            if(Math.random() > 0.6) {
                entities.push({ type: 'bush', biome: type, x: x, y: y, width: 60 });
            } else {
                let obsType = 'rock';
                if(type === 'city') obsType = (Math.random()>0.5 ? 'hydrant' : 'trash');
                if(type === 'forest') obsType = 'tree';
                entities.push({ type: 'obstacle', subtype: obsType, x: x, y: y, width: 30 });
            }
        }

        for(let i=0; i<count; i++) {
            let speedMod = (DIFFICULTY === 1) ? -0.5 : (DIFFICULTY === 3 ? 0.5 : 0);
            let baseSpd = 2.0 + speedMod;
            if(type === 'snow') baseSpd += 0.5; 
            let sight = (type === 'city' ? 250 : 350);

            entities.push({
                type: 'dog', biome: type,
                x: Math.random() * (GAME_WIDTH-100) + 50,
                y: Math.random() * (maxY - minY) + minY,
                speed: baseSpd, state: 'roam',
                angle: Math.random()*6.28,
                timer: 0, chaseTimer: 0, sniffTimer: 0,
                sightRange: sight,
                minY: minY, maxY: maxY
            });
        }

        let tCount = Math.max(5, Math.floor(settings.treats * (DIFFICULTY === 1 ? 0.8 : 1.2)));
        for(let i=0; i<tCount; i++) {
            entities.push({ type: 'treat', x: Math.random() * (GAME_WIDTH-100) + 50, y: Math.random() * (maxY - minY) + minY, z: 5, phase: Math.random()*Math.PI });
        }
    }

    function loop() {
        if(!gameActive) return;
        const now = Date.now();
        const dt = Math.min((now - lastTime)/1000, 0.1);
        lastTime = now;
        globalTime += dt;
        update(dt);
        render();
        requestAnimationFrame(loop);